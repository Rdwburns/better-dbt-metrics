# dbt Project Integration Guide

This guide explains how to integrate better-dbt-metrics with your existing dbt project.

## Quick Setup

### 1. Install better-dbt-metrics

```bash
pip install better-dbt-metrics
```

### 2. Add to dbt_project.yml

Add this configuration to your `dbt_project.yml`:

```yaml
# dbt_project.yml
name: 'your_project_name'
version: '1.0.0'
config-version: 2

# Model paths
model-paths: ["models"]
analysis-paths: ["analyses"]
test-paths: ["tests"]
seed-paths: ["seeds"]
macro-paths: ["macros"]
snapshot-paths: ["snapshots"]

# Include semantic models generated by better-dbt-metrics
target-path: "target"
clean-targets:
  - "target"
  - "dbt_packages"
  - "models/semantic"  # Add this to clean compiled metrics

# Configure semantic model compilation
models:
  your_project_name:
    semantic:
      +materialized: view
      +docs:
        node_color: "#8B4513"
      +meta:
        generated_by: "better-dbt-metrics"

# Hooks to compile metrics before dbt run
on-run-start:
  - "{{ log('Compiling better-dbt-metrics...', info=True) }}"

on-run-end:
  - "{{ log('Metrics compilation complete', info=True) }}"
```

### 3. Project Structure

Organize your project like this:

```
your_dbt_project/
├── dbt_project.yml          # Your main dbt configuration
├── metrics/                 # Better-dbt-metrics definitions
│   ├── finance/
│   │   ├── revenue.yml
│   │   └── costs.yml
│   ├── product/
│   │   └── usage.yml
│   └── _base/              # Shared templates (underscore = skip compilation)
│       └── templates/
│           ├── dimensions/
│           └── metrics/
├── models/
│   ├── staging/           # Your existing dbt models
│   ├── marts/
│   └── semantic/          # Generated by better-dbt-metrics (auto-created)
│       ├── metrics/
│       └── semantic_models/
└── macros/               # Your existing macros
```

## GitHub Actions Integration

### 4. Add Compilation Workflow

Create `.github/workflows/compile-metrics.yml`:

```yaml
name: Compile Metrics
on:
  push:
    paths: ['metrics/**']
  pull_request:
    paths: ['metrics/**']

jobs:
  compile-metrics:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          
      - name: Install dependencies
        run: |
          pip install better-dbt-metrics
          
      - name: Compile metrics
        run: |
          better-dbt-metrics compile \
            --input-dir metrics/ \
            --output-dir models/semantic/ \
            --validate
            
      - name: Commit compiled models
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add models/semantic/
          git diff --staged --quiet || git commit -m "Compile metrics [skip ci]"
          git push
```

## Development Workflow

### 5. Local Development

```bash
# 1. Create/edit metrics
vim metrics/finance/revenue.yml

# 2. Compile metrics
better-dbt-metrics compile --input-dir metrics/ --output-dir models/semantic/

# 3. Run dbt as normal
dbt run
dbt test
```

### 6. Validation

```bash
# Validate metrics before compilation
better-dbt-metrics validate --input-dir metrics/

# Fix any validation errors
better-dbt-metrics validate --input-dir metrics/ --fix
```

## Configuration Options

### Environment-Specific Settings

Create `metrics/config.yml`:

```yaml
# Global configuration for better-dbt-metrics
template_dirs:
  - "_base/templates/"
  - "shared/templates/"

dimension_group_dirs:
  - "_base/templates/dimensions/"

environments:
  dev:
    materialized: view
    sample_data: true
    
  prod:
    materialized: table
    partition_by: date_day
```

### Override CLI defaults

```bash
better-dbt-metrics compile \
  --input-dir metrics/ \
  --output-dir models/semantic/ \
  --template-dir _base/templates/ \
  --dimension-group-dir _base/templates/dimensions/ \
  --environment prod \
  --config metrics/config.yml
```

## Troubleshooting

### Common Issues

1. **"Metrics directory not recognized by dbt"**
   - Solution: Use `models/semantic/` as output directory, not `metrics/`
   - dbt only recognizes models in the `models/` directory

2. **"Import file not found"**
   - Check that template files exist in `_base/` directories
   - Use relative paths: `../templates/dimensions/temporal.yml`

3. **"'list' object has no attribute 'get'"**
   - Update better-dbt-metrics to latest version
   - This was fixed in recent releases

### Integration Checklist

- [ ] better-dbt-metrics installed (`pip install better-dbt-metrics`)
- [ ] `dbt_project.yml` updated with semantic model configuration
- [ ] Metrics output to `models/semantic/` directory
- [ ] GitHub Actions workflow configured
- [ ] Template directories created in `_base/`
- [ ] Validation passes (`better-dbt-metrics validate`)
- [ ] Compilation succeeds (`better-dbt-metrics compile`)
- [ ] dbt run works with generated models

### Support

For additional help:
- Check the [examples/](examples/) directory for working configurations
- Review [CLAUDE.md](CLAUDE.md) for architecture decisions
- Open issues on GitHub for bugs or feature requests